[% BLOCK category_list %]
<select class="form-control" name="[% field_name %]" id="[% field_name %]">
  [% IF category_options.size %]
        [%~ IF category_groups.size ~%]
            [%~ FOREACH group IN category_groups ~%]
                [% IF group.name %]<optgroup label="[% group.name %]">[% END %]
                [% group_select = 0 %]
                [% selected = 0 %]
                [%~ FOREACH cat_op IN group.categories ~%]
                    [% IF group_select == 0 AND problem.category == group.name %]
                        [% selected = 1; group_select = 1 %]
                    [% END %]
                    <option value="[% cat_op.id %]"[% ' selected' IF selected OR problem.category == cat_op.category %]>[% cat_op.category_display %] ([% cat_op.email %])</option>
                    [% selected = 0 %]
                [%~ END ~%]
                [% IF group.name %]</optgroup>[% END %]
            [%~ END =%]
        [% ELSE %]
              [% FOREACH cat IN category_options %]
                <option value="[% cat.id %]"[% ' selected' IF problem.category == cat.category %]>[% cat.category_display %]</option>
              [% END %]
      [% END %]
  [% END %]
</select>
[% END %]

